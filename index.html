<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Studio Nilza Alves - Agendamento</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, #FFF5F3 0%, #FFE8E3 100%); min-height: 100vh; margin: 0; }
    h1, h2, h3 { font-family: 'Playfair Display', serif; }
    .btn-primary { background-color: #C79081; color: white; transition: all 0.3s; }
    .btn-primary:hover { background-color: #B8806E; transform: translateY(-1px); }
    .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #C79081; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="h-full">
  <div id="app" class="w-full h-full overflow-auto p-4 sm:p-8">
    <div class="flex items-center justify-center h-64">
      <div class="loading-spinner"></div>
    </div>
  </div>

  <script>
    // Configurações Globais
    const SUPABASE_URL = 'https://bfymvjnqkzrsyexfwdcp.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_H6CY2ywkSPiYkhtFj15Xcg_PCxOpZTf';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allBookings = [];
    let selectedServices = [];
    let selectedDate = new Date().toISOString().split('T')[0];
    let selectedTime = null;
    let adminMode = sessionStorage.getItem('adminLoggedIn') === 'true';

    // Lista de serviços fixa (para garantir que o site carregue se o banco falhar)
    const defaultServices = [
      { id: 'buco', name: 'Buço', duration: 15, price: 15.00 },
      { id: 'axila', name: 'Axila', duration: 20, price: 20.00 },
      { id: 'meia_perna', name: 'Meia Perna', duration: 30, price: 40.00 },
      { id: 'perna_completa', name: 'Perna Completa', duration: 45, price: 60.00 },
      { id: 'virilha_completa', name: 'Virilha Completa', duration: 30, price: 40.00 }
    ];

    // Carregar dados
    async function init() {
      try {
        const { data, error } = await _supabase.from('bookings').select('*');
        if (!error) allBookings = data;
      } catch (e) {
        console.error("Erro banco:", e);
      }
      render();
    }

    function render() {
      const app = document.getElementById('app');
      if (adminMode) {
        renderAdmin();
      } else {
        renderClient();
      }
    }

    function renderClient() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="max-w-2xl mx-auto space-y-8 pb-20">
          <header class="text-center py-6">
            <img src="https://i.ibb.co/sd0VY9CY/Logo-principal.png" class="h-32 mx-auto mb-4" alt="Logo">
            <h1 class="text-3xl font-bold text-gray-800">Studio Nilza Alves</h1>
            <p class="text-sm text-gray-500">Agende seu horário online</p>
          </header>

          <section class="card p-6">
            <h2 class="text-xl font-bold mb-4">1. Selecione os Serviços</h2>
            <div class="grid grid-cols-1 gap-3">
              ${defaultServices.map(s => `
                <div onclick="toggleService('${s.id}')" class="p-4 border-2 rounded-xl cursor-pointer transition ${selectedServices.includes(s.id) ? 'border-[#C79081] bg-[#FFF5F3]' : 'border-gray-100'}">
                  <div class="flex justify-between font-bold"><span>${s.name}</span> <span>R$ ${s.price.toFixed(2)}</span></div>
                  <p class="text-xs text-gray-400">${s.duration} min</p>
                </div>
              `).join('')}
            </div>
          </section>

          <section class="card p-6">
            <h2 class="text-xl font-bold mb-4">2. Data e Hora</h2>
            <input type="date" value="${selectedDate}" onchange="changeDate(this.value)" class="w-full p-3 border rounded-lg mb-6 outline-none" min="${new Date().toISOString().split('T')[0]}">
            
            <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">
              ${generateSlots().map(t => `
                <button onclick="selectTime('${t.time}')" class="p-2 text-sm rounded-lg border ${selectedTime === t.time ? 'bg-[#C79081] text-white border-[#C79081]' : 'bg-gray-50 border-transparent'} ${!t.available ? 'opacity-20 cursor-not-allowed' : ''}" ${!t.available ? 'disabled' : ''}>${t.time}</button>
              `).join('')}
            </div>
          </section>

          ${selectedTime && selectedServices.length > 0 ? `
            <button onclick="confirmFlow()" class="w-full py-4 btn-primary rounded-2xl font-bold shadow-lg">FINALIZAR AGENDAMENTO</button>
          ` : ''}

          <div class="text-center pt-8">
            <button onclick="askAdmin()" class="text-xs text-gray-300">Acesso Administrativo</button>
          </div>
        </div>
      `;
    }

    function generateSlots() {
      const slots = [];
      const d = new Date(selectedDate + 'T12:00:00');
      const day = d.getDay();
      if (day === 0) return []; // Domingo fechado

      let start = 9, end = (day === 6) ? 17 : 19;

      for (let h = start; h < end; h++) {
        for (let m = 0; m < 60; m += 30) {
          const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
          const isBusy = allBookings.some(b => b.type === 'booking' && b.date === selectedDate && b.time === time && b.status === 'confirmed');
          slots.push({ time, available: !isBusy });
        }
      }
      return slots;
    }

    function toggleService(id) {
      const idx = selectedServices.indexOf(id);
      idx > -1 ? selectedServices.splice(idx, 1) : selectedServices.push(id);
      render();
    }

    function changeDate(val) {
      selectedDate = val;
      selectedTime = null;
      render();
    }

    function selectTime(t) {
      selectedTime = t;
      render();
    }

    async function confirmFlow() {
      const name = prompt("Seu nome:");
      const phone = prompt("Seu WhatsApp:");
      if (!name || !phone) return;

      const booking = {
        type: 'booking',
        client_name: name,
        client_phone: phone,
        services: selectedServices.join(','),
        date: selectedDate,
        time: selectedTime,
        status: 'confirmed'
      };

      const { error } = await _supabase.from('bookings').insert([booking]);
      if (!error) {
        alert("Sucesso! Agendado.");
        location.reload();
      } else {
        alert("Erro ao salvar no banco.");
      }
    }

    function askAdmin() {
      if (prompt("Senha:") === '123456') {
        adminMode = true;
        sessionStorage.setItem('adminLoggedIn', 'true');
        render();
      }
    }

    function renderAdmin() {
      const bookings = allBookings.filter(b => b.type === 'booking');
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="max-w-4xl mx-auto">
          <div class="flex justify-between mb-8">
            <h1 class="text-2xl font-bold">Agendamentos</h1>
            <button onclick="sessionStorage.clear(); location.reload()" class="text-red-500">Sair</button>
          </div>
          <div class="card overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-gray-100"><tr><th class="p-3 text-left">Data</th><th class="p-3 text-left">Hora</th><th class="p-3 text-left">Cliente</th><th class="p-3">Ação</th></tr></thead>
              <tbody>
                ${bookings.map(b => `
                  <tr class="border-t">
                    <td class="p-3">${b.date}</td><td class="p-3">${b.time}</td><td class="p-3">${b.client_name}</td>
                    <td class="p-3 text-center"><button onclick="deleteBooking('${b.__backendId}')" class="text-red-500">Excluir</button></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    async function deleteBooking(id) {
      if (confirm("Excluir?")) {
        await _supabase.from('bookings').delete().eq('__backendId', id);
        init();
      }
    }

    // Ligar o sistema
    init();
  </script>
</body>
</html>
