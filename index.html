<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Studio Nilza Alves - Administrativo</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    :root { --primary: #C79081; --secondary: #E8B4A8; --bg: #FFF5F3; }
    body { font-family: 'Montserrat', sans-serif; background: var(--bg); margin: 0; min-height: 100vh; }
    h1, h2, h3 { font-family: 'Playfair Display', serif; }
    
    .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 1.5rem; box-shadow: 0 10px 30px rgba(199, 144, 129, 0.1); }
    
    .calendar-day { transition: all 0.2s; border-radius: 0.75rem; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .calendar-day.active { background: var(--primary); color: white; font-weight: bold; }
    .calendar-day.disabled { opacity: 0.2; cursor: not-allowed; text-decoration: line-through; }
    
    .time-slot { transition: all 0.2s; border: 1px solid #eee; cursor: pointer; }
    .time-slot.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    .admin-table { width: 100%; border-collapse: collapse; }
    .admin-table th { background: var(--primary); color: white; padding: 12px; text-align: left; font-size: 0.8rem; text-transform: uppercase; }
    .admin-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
    
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>
  <div id="app" class="p-4 sm:p-8">
      <div class="flex items-center justify-center h-64"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#C79081]"></div></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://bfymvjnqkzrsyexfwdcp.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_H6CY2ywkSPiYkhtFj15Xcg_PCxOpZTf';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allBookings = [];
    let selectedServices = [];
    let selectedDate = new Date();
    let selectedTime = null;
    let adminLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';

    const services = [
      { id: 'buco', name: 'Buço', duration: 15, price: 15.00 },
      { id: 'axila', name: 'Axila', duration: 20, price: 20.00 },
      { id: 'meia_perna', name: 'Meia Perna', duration: 30, price: 40.00 },
      { id: 'perna_completa', name: 'Perna Completa', duration: 45, price: 60.00 },
      { id: 'virilha_completa', name: 'Virilha Completa', duration: 30, price: 40.00 }
    ];

    async function loadData() {
      const { data } = await _supabase.from('bookings').select('*').order('date', {ascending: true});
      allBookings = data || [];
      render();
    }

    function render() {
      const app = document.getElementById('app');
      if (adminLoggedIn) return renderAdmin();

      app.innerHTML = `
        <div class="max-w-5xl mx-auto fade-in">
          <header class="text-center mb-10">
            <img src="https://i.ibb.co/sd0VY9CY/Logo-principal.png" class="h-32 mx-auto mb-4">
            <h1 class="text-4xl font-bold text-gray-800">Studio Nilza Alves</h1>
          </header>

          <div class="grid lg:grid-cols-2 gap-8">
            <div class="space-y-4">
              <h2 class="text-xl font-bold border-b-2 border-[#C79081] inline-block">1. Serviços</h2>
              <div class="grid gap-2">
                ${services.map(s => `
                  <div onclick="toggleSrv('${s.id}')" class="glass-card p-4 flex justify-between items-center cursor-pointer border-2 ${selectedServices.includes(s.id) ? 'border-[#C79081]' : 'border-transparent'}">
                    <span>${s.name} <small class="block opacity-50">${s.duration} min</small></span>
                    <span class="font-bold text-[#C79081]">R$ ${s.price.toFixed(2)}</span>
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="space-y-6">
              <h2 class="text-xl font-bold border-b-2 border-[#C79081] inline-block">2. Data e Hora</h2>
              <div class="glass-card p-4">${renderCalendar()}</div>
              <div class="grid grid-cols-4 gap-2">
                ${generateSlots().map(t => `
                  <button onclick="selectedTime='${t.time}';render()" class="time-slot p-2 rounded-lg text-xs ${selectedTime === t.time ? 'active' : 'bg-white'} ${!t.available ? 'opacity-20 disabled' : ''}" ${!t.available ? 'disabled' : ''}>${t.time}</button>
                `).join('')}
              </div>
              ${selectedTime && selectedServices.length > 0 ? `<button onclick="openForm()" class="w-full py-4 bg-[#C79081] text-white rounded-xl font-bold shadow-xl">RESERVAR AGORA</button>` : ''}
            </div>
          </div>
          <div class="mt-12 text-center"><button onclick="tryAdmin()" class="text-[10px] opacity-20">ADM</button></div>
        </div>
      `;
    }

    // --- FUNÇÕES AUXILIARES ---
    function toggleSrv(id) {
      const i = selectedServices.indexOf(id);
      i > -1 ? selectedServices.splice(i, 1) : selectedServices.push(id);
      render();
    }

    function renderCalendar() {
      const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
      const daysInMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).getDate();
      const startDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1).getDay();
      const today = new Date(); today.setHours(0,0,0,0);

      let html = `<div class="flex justify-between items-center mb-4"><button onclick="moveM(-1)">◀</button><b>${monthNames[selectedDate.getMonth()]}</b><button onclick="moveM(1)">▶</button></div><div class="grid grid-cols-7 gap-1 text-[10px] text-center mb-2"><div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div></div><div class="grid grid-cols-7 gap-1">`;
      for (let i = 0; i < startDay; i++) html += `<div></div>`;
      for (let d = 1; d <= daysInMonth; d++) {
        const curr = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), d);
        const dateStr = curr.toISOString().split('T')[0];
        const isSun = curr.getDay() === 0;
        const isRel = isSun && allBookings.some(b => b.type === 'blocked_date' && b.blocked_date === dateStr && b.blocked_reason === 'LIBERADO');
        const dis = curr < today || (isSun && !isRel);
        html += `<div onclick="${dis ? '' : `setD(${d})`}" class="calendar-day ${dateStr === selectedDate.toISOString().split('T')[0] ? 'active' : ''} ${dis ? 'disabled' : ''}">${d}</div>`;
      }
      return html + '</div>';
    }

    function generateSlots() {
      const slots = [];
      const day = selectedDate.getDay();
      if (day === 0 && !allBookings.some(b => b.type === 'blocked_date' && b.blocked_date === selectedDate.toISOString().split('T')[0] && b.blocked_reason === 'LIBERADO')) return [];
      let end = (day === 6) ? 17 : 19;
      for (let h = 9; h < end; h++) {
        for (let m of ['00', '30']) {
          const t = `${String(h).padStart(2, '0')}:${m}`;
          const busy = allBookings.some(b => b.type === 'booking' && b.date === selectedDate.toISOString().split('T')[0] && b.time === t && b.status === 'confirmed');
          slots.push({ time: t, available: !busy });
        }
      }
      return slots;
    }

    function moveM(s) { selectedDate.setMonth(selectedDate.getMonth() + s); render(); }
    function setD(d) { selectedDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), d); selectedTime = null; render(); }

    function openForm() {
      const n = prompt("Seu Nome:");
      const p = prompt("Seu WhatsApp:");
      if(n && p) saveB(n, p);
    }

    async function saveB(n, p) {
      const b = { type: 'booking', client_name: n, client_phone: p, services: selectedServices.join(','), date: selectedDate.toISOString().split('T')[0], time: selectedTime, status: 'confirmed' };
      await _supabase.from('bookings').insert([b]);
      alert("Agendado!"); location.reload();
    }

    // --- ÁREA ADMINISTRATIVA ---
    function tryAdmin() {
      if(prompt("Senha:") === '123456') { adminLoggedIn = true; sessionStorage.setItem('adminLoggedIn', 'true'); render(); }
    }

    function renderAdmin() {
      const app = document.getElementById('app');
      const bookings = allBookings.filter(b => b.type === 'booking');
      const blocks = allBookings.filter(b => b.type === 'blocked_date');

      app.innerHTML = `
        <div class="max-w-6xl mx-auto fade-in">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Painel de Controle</h1>
            <button onclick="sessionStorage.clear(); location.reload()" class="bg-white px-4 py-2 rounded-lg text-sm shadow">Sair</button>
          </div>

          <div class="grid lg:grid-cols-3 gap-8">
            <div class="glass-card p-6 h-fit">
              <h3 class="font-bold mb-4">Bloquear/Liberar Data</h3>
              <div class="space-y-3">
                <input type="date" id="blockDate" class="w-full p-2 border rounded">
                <input type="text" id="blockReason" placeholder="Motivo ou LIBERADO" class="w-full p-2 border rounded text-sm">
                <button onclick="addBlock()" class="w-full bg-black text-white p-2 rounded text-sm">Salvar Regra</button>
              </div>
              <div class="mt-6 space-y-2">
                ${blocks.map(bl => `
                  <div class="flex justify-between text-[10px] bg-white p-2 rounded shadow-sm">
                    <span><b>${bl.blocked_date}</b>: ${bl.blocked_reason}</span>
                    <button onclick="delB('${bl.__backendId}')" class="text-red-500">Apagar</button>
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="lg:col-span-2 glass-card overflow-hidden">
              <div class="p-4 bg-white/50 border-b font-bold">Próximos Agendamentos</div>
              <div class="overflow-x-auto">
                <table class="admin-table">
                  <thead><tr><th>Data/Hora</th><th>Cliente</th><th>Telefone</th><th>Serviços</th><th>Ação</th></tr></thead>
                  <tbody>
                    ${bookings.map(b => `
                      <tr>
                        <td><b>${b.date}</b><br>${b.time}</td>
                        <td>${b.client_name}</td>
                        <td><a href="https://wa.me/${b.client_phone}" target="_blank" class="text-green-600 underline">${b.client_phone}</a></td>
                        <td class="text-[10px]">${b.services}</td>
                        <td><button onclick="delB('${b.__backendId}')" class="bg-red-50 text-red-500 p-2 rounded">Excluir</button></td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function addBlock() {
      const d = document.getElementById('blockDate').value;
      const r = document.getElementById('blockReason').value;
      if(!d || !r) return alert("Preencha tudo");
      await _supabase.from('bookings').insert([{ type: 'blocked_date', blocked_date: d, blocked_reason: r }]);
      loadData();
    }

    async function delB(id) {
      if(confirm("Deseja apagar?")) {
        await _supabase.from('bookings').delete().eq('__backendId', id);
        loadData();
      }
    }

    window.onload = loadData;
  </script>
</body>
</html>
